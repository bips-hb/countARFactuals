---
title: "Customized distance functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Customized distance functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this example, we demonstrate how customized distance functions can be used in counterfactual methods (e.g. `WhatIfClassif`) 
and the resulting `Counterfactuals` object. 

```{r example, message=FALSE}
library(counterfactuals)
library(randomForest)
library(iml)
```

### Set up

```{r}
rf = randomForest(Species ~ ., data = iris[-150L, ])
predictor = Predictor$new(rf, type = "prob")
x_interest = iris[150L, ]
predictor$predict(x_interest)
```

### Customize the distance function in counterfactual methods

By default, `MOCClassif` uses the Gower distance for the second and forth MOC objective. 
We can customize the function by using the `distance_function` argument in the `initiliaze()` method. <br>
A customized distance function must have three arguments: `x`, `y`, and `data` and return a double matrix with `nrow(x)`
rows and `nrow(y)` columns.  <br>
The `data` argument contains `predictor$data$X` and can be used to calculate statistics used by the distance measure, 
e.g., standard deviation or range. 

```{r}
scaled_euclidean_distance = function(x, y, data) {
    means = data[, lapply(.SD, mean)]
    sds = data[, lapply(.SD, sd)]
    x_scaled = scale(x, center = means, scale = sds)
    y_scaled = scale(y, center = means, scale = sds)

    res = matrix(NA, nrow = nrow(x_scaled), ncol = nrow(y_scaled))
    for (i in 1:nrow(x_scaled)) {
      for (j in 1:nrow(y_scaled)) {
        res[i, j] = sqrt(sum(((x_scaled[i, ] - y_scaled[j, ])^2)))
      }
    }
    res
}
```

```{r, results='hide'}
moc_classif = MOCClassif$new(
  predictor, 
  n_generations = 10L, 
  distance_function = scaled_euclidean_distance
)
cfactuals = moc_classif$find_counterfactuals(
  x_interest, 
  desired_class = "versicolor",
  desired_prob = c(0.5, 1)
)
```

```{r}
cfactuals
```


### Customize the distance function in the Counterfactuals object

```{r}
cfactuals$distance_function = scaled_euclidean_distance
```

```{r}
head(cfactuals$evaluate(), 3L)
```





